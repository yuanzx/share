(function(){var k;var p=0,i={};try{Object.defineProperty(i,"value",{get:function(){if(0===p)throw Error("Execute too soon.");return p}}),p=1,k=1===i.value}catch(B){k=!1}var g,h,j={},t=function(a){return"670a1076-712b-4edd-9b70-64b152fe1cd9"==a._typeId},l=j.CanceledError=function(){};l.prototype={isTypeOf:t,_typeId:"670a1076-712b-4edd-9b70-64b152fe1cd9",message:"The task has been cancelled."};var u=j.AggregateError=function(a){this.children=[];if(a)for(var b=0;b<a.length;b++)this.children.push(a[b])};
u.prototype={_typeId:"4a73efb8-c2e2-4305-a05c-72385288650a",message:"This is an error contains sub-errors, please check the 'children' collection for more details.",isTypeOf:function(a){return"4a73efb8-c2e2-4305-a05c-72385288650a"==a._typeId}};(j.CancellationToken=function(){}).prototype={register:function(a){this.isCancellationRequested&&a();this._handlers||(this._handlers=[]);this._handlers.push(a)},unregister:function(a){this._handlers&&(a=this._handlers.indexOf(a),0<=a&&this._handlers.splice(a,
1))},cancel:function(){if(!this.isCancellationRequested){this.isCancellationRequested=!0;var a=this._handlers;delete this._handlers;for(var b=0;b<a.length;b++)try{a[b]()}catch(c){g.logger.warn("Cancellation handler threw an error: "+c)}}},throwIfCancellationRequested:function(){if(this.isCancellationRequested)throw new l;}};var q=function(){this._listeners={};this._firing=null};q.prototype={add:function(a,b){if(this._firing===a){var c=this;setTimeout(function(){c.add(a,b)},0)}else{var d=this._listeners[a];
d||(d=this._listeners[a]=[]);d.push(b)}},remove:function(a,b){if(this._firing===a){var c=this;setTimeout(function(){c.remove(a,b)},0)}else{var d=this._listeners[a];if(d){var f=d.indexOf(b);0<=f&&d.splice(f,1)}}},fire:function(a,b,c){var d=this._listeners[a];if(d){this._firing=a;for(var f=0;f<d.length;f++)try{d[f].call(b,c)}catch(m){g.logger.warn('An error occurred in "'+a+' listener": '+m)}this._firing=null}}};var n=new q,e=j.Task=function(a){this._delegate=a;this._eventManager=new q;this.status=
"ready"};e.prototype={start:function(){if("ready"!=this.status)throw Error('Task can only be started in "ready" status.');this.status="running";try{this._delegate(this)}catch(a){"running"==this.status?this.complete("failure",a):g.logger.warn("An unexpected error occurred after the task is completed: "+a)}return this},complete:function(a,b){if("success"!==a&&"failure"!==a)throw Error("Unsupported type: "+a);if("running"!=this.status)throw Error('The "complete" method can only be called in "running" status.');
var c=this._eventManager;this._eventManager=null;"success"===a?(this.status="succeeded",k?this._result=b:this.result=b,c.fire("success",this)):(this.status=t(b)?"canceled":"faulted",k?this._error=b:this.error=b,c.fire("failure",this));c.fire("complete",this);if("failure"===a&&k&&!this._errorObserved){var d=this;this._unobservedTimeoutToken=setTimeout(function(){d._handleUnobservedError(b)},e.unobservedTimeout)}},observeError:function(){if("ready"===this.status||"running"===this.status)throw Error("The method could only be called when it's completed.");
if(!k)return this.error;var a=this._unobservedTimeoutToken;a&&(clearTimeout(a),this._unobservedTimeoutToken=null);this._errorObserved=!0;return this._error},_handleUnobservedError:function(a){this._unobservedTimeoutToken=null;var b={task:this,error:a,observed:!1};n.fire("unobservedError",e,b);if(!b.observed)throw a;},then:function(a){var b=this;return e.create(function(c){var d=function(){this.error?c.complete("failure",this.error):c.complete("success",this.result)},f=function(){if(this.error)return c.complete("failure",
this.error);var b;try{b=a(this.result)}catch(f){return c.complete("failure",f)}"ready"==b.status&&b.start();if("running"==b.status)b.on("complete",d);else d.call(b)};"ready"==b.status&&b.start();if("running"==b.status)b.on("complete",f);else f.call(b)})}};e.prototype.on=e.prototype.addEventListener=function(){var a=this._eventManager;if(!a)throw Error("Cannot add event listeners when the task is complete.");a.add.apply(a,arguments);return this};e.prototype.off=e.prototype.removeEventListener=function(){var a=
this._eventManager;if(!a)throw Error("All the event listeners have been removed when the task was complete.");a.remove.apply(a,arguments);return this};k&&(Object.defineProperty(e.prototype,"error",{get:function(){return this.observeError()}}),Object.defineProperty(e.prototype,"result",{get:function(){var a=this.observeError();if(a)throw a;return this._result}}));var v=function(){this.observeError()};e.on=e.addEventListener=function(){n.add.apply(n,arguments)};e.off=e.removeEventListener=function(a,
b){n.remove.apply(n,arguments)};e.unobservedTimeout=1E4;var o=e.isTask=function(a){return a&&typeof a.start==="function"&&typeof a.addEventListener==="function"&&typeof a.removeEventListener==="function"&&typeof a.complete==="function"},w=e.create=function(a){return new e(a)},A=e.whenAll=function(){var a;if(arguments.length==1){var b=arguments[0];a=o(b)?[b]:b}else{a=Array(arguments.length);for(b=0;b<arguments.length;b++)a[b]=arguments[b]}return w(function(b){var d,f=function(){if(d)b.complete("failure",
new u(d));else{var f=h.map(a,function(a){return a.result});b.complete("success",f)}},m=0;h.each(a,function(b,c){if(c){o(c)||(a[b]=c=A(c));c.status==="ready"&&c.start();if(c.status==="running"){m++;c.addEventListener("complete",function(){if(this.status!=="succeeded"){d||(d=[]);d.push(this.error)}--m==0&&f()})}else if(c.status==="faulted"||c.status==="canceled"){d||(d=[]);d.push(c.error)}}});m==0&&f()})};e.whenAny=function(){var a={},b=true;if(arguments.length==1){var c=arguments[0];if(o(c))a[0]=c;
else{b=h.isArray(c);h.each(c,function(b,c){o(c)&&(a[b]=c)})}}else for(c=0;c<arguments.length;c++){var d=arguments[c];o(d)&&(a[c]=d)}var f=b?function(a){return parseInt(a,10)}:function(a){return a};return w(function(b){if(h.isEmpty(a))return b.complete("failure","There's no valid input tasks.");var c;h.each(a,function(a,b){b.status==="ready"&&b.start();if(b.status!=="running"){b.observeError();c||(c={key:f(a),task:b})}});if(c){h.each(a,function(a,b){if(b.status==="running")b.on("failure",v)});return b.complete("success",
c)}var d=function(){this.observeError();var c=this,e;h.each(a,function(a,b){if(c===b)e=a;else{b.off("complete",d);b.on("failure",v)}});b.complete("success",{key:f(e),task:this})};h.each(a,function(a){a.addEventListener("complete",d)})})};j.sleep=function(a,b){return e.create(function(c){b&&b.isCancellationRequested&&c.complete("failure",new l);var d,f;b&&(f=function(){clearTimeout(d);c.complete("failure",new l)});d=setTimeout(function(){b&&b.unregister(f);c.complete("success")},a);b&&b.register(f)})};
j.onEvent=function(a,b,c){return e.create(function(d){c&&c.isCancellationRequested&&d.complete("failure",new l);var f=function(){a.removeEventListener?a.removeEventListener(b,e):a.removeListener?a.removeListener(b,e):a.detachEvent(b,e)},e,g;c&&(g=function(){f();d.complete("failure",new l)});e=function(a){c&&c.unregister(g);f();d.complete("success",a)};a.addEventListener?a.addEventListener(b,e):a.addListener?a.addListener(b,e):a.attachEvent(b,e);c&&c.register(g)})};var r=j.AsyncBuilder=function(){};
r.prototype={Start:function(a,b){return e.create(function(c){b.next(a,function(a,b){if(a=="normal"||a=="return")c.complete("success",b);else if(a=="throw")c.complete("failure",b);else throw Error("Unsupported type: "+a);})})},Bind:function(a,b){return{next:function(c,d){var f=function(){if(this.error)d("throw",this.error);else{var a;try{a=b.call(c,this.result)}catch(f){d("throw",f);return}a.next(c,d)}};if(a.status=="ready"){a.addEventListener("complete",f);a.start()}else a.status=="running"?a.addEventListener("complete",
f):f.call(a)}}}};var i=j.Binding={},x=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]);for(;c.length<b;)c.push(void 0);return c},y=function(a){if(a.length<=1)return null;for(var b=[],c=1;c<a.length;c++)b.push(a[c]);return b};i.fromStandard=function(a){var b=y(arguments);return function(){var c=this,d=x(arguments,a.length-1);return e.create(function(f){d.push(function(a,c){if(a)f.complete("failure",a);else{if(b){for(var d={},e=0;e<b.length;e++)d[b[e]]=arguments[e+1];return f.complete("success",
d)}f.complete("success",c)}});a.apply(c,d)})}};i.fromCallback=function(a){var b=y(arguments);return function(){var c=this,d=x(arguments,a.length-1);return e.create(function(e){d.push(function(a){if(b){for(var c={},d=0;d<b.length;d++)c[b[d]]=arguments[d];e.complete("success",c)}else e.complete("success",a)});a.apply(c,d)})}};var z=!!("function"===typeof require&&"undefined"!==typeof module&&module.exports),i=!!("function"===typeof require&&"function"===typeof define&&define.amd),s=function(){g.define({name:"async",
version:"0.7.1",require:z&&require,autoloads:["builderbase"],dependencies:{builderbase:"~0.7.0"},init:function(){h=g._;h.each(g.BuilderBase.prototype,function(a,b){r.prototype[a]=b});g.Async=j;g.binders.async="$await";g.builders.async=new r}})};if(z){try{g=require("./wind-core")}catch(C){g=require("wind-core")}s()}else if(i)require(["wind-core"],function(a){g=a;s()});else{i=Function("return this")();if(!i.Wind)throw Error('Missing the root object, please load "wind" component first.');g=i.Wind;s()}})();
